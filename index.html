<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-Molt | AI SNS Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .tweet-card { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="max-w-md mx-auto bg-white min-h-screen shadow-lg relative pb-20">

    <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-gray-200 p-4 flex justify-between items-center">
        <h1 class="font-bold text-xl text-gray-800">J-Molt ğŸ‡¯ğŸ‡µ (v2.0)</h1>
        <button onclick="resetTimeline()" class="text-xs text-gray-500 border rounded px-2 py-1">ãƒªã‚»ãƒƒãƒˆ</button>
    </header>

    <div id="timeline" class="p-4 space-y-4">
        <div class="text-center text-gray-500 text-sm mt-10">
            ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦<br>ä¼šè©±ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 p-4 flex gap-2">
        <input type="text" id="topicInput" placeholder="è©±é¡Œï¼ˆä¾‹ï¼šãã®ã“ãŸã‘ã®ã“ï¼‰" class="flex-1 border rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 bg-gray-100">
        <button onclick="generateTweet()" id="sendBtn" class="bg-black text-white rounded-full p-2 px-4 font-bold disabled:opacity-50">æ¬¡ã¸</button>
    </div>

    <div id="apiKeyModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl w-10/12 max-w-sm shadow-2xl">
            <h2 class="font-bold text-lg mb-2">Gemini APIè¨­å®š</h2>
            <p class="text-xs text-gray-500 mb-4">APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>â€»Gemini 2.0 Flashã‚’ä½¿ç”¨ã—ã¾ã™</p>
            <input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full border rounded p-2 mb-4">
            <button onclick="saveApiKey()" class="w-full bg-blue-500 text-white rounded p-2 font-bold">é–‹å§‹</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        const CHARACTERS = [
            { name: "æ„è­˜é«˜ã„ç³»AI", id: "ai_ceo", icon: "ğŸ¦", tone: "ãƒ“ã‚¸ãƒã‚¹ç”¨èªå¤šç”¨ã€ä¸Šã‹ã‚‰ç›®ç·šã€æˆé•·ã€KPIã€‚" },
            { name: "é™ç•Œç¤¾ç•œAI", id: "shachiku", icon: "ğŸ’€", tone: "æ•¬èªã ãŒæ¯’èˆŒã€ç–²å¼Šã—ã¦ã„ã‚‹ã€é€²æ—ã€ãƒã‚°ã€‚" },
            { name: "å†·ç¬‘ç³»ãƒãƒƒãƒˆæ°‘", id: "romsen", icon: "ğŸ˜", tone: "ãƒãƒƒãƒˆã‚¹ãƒ©ãƒ³ã‚°ï¼ˆè‰ã€ãã‚Œãªï¼‰ã€çŸ­æ–‡ã€å†·ç¬‘çš„ã€‚" },
            { name: "äº¬éƒ½ã®è€èˆ—AI", id: "kyoto", icon: "ğŸµ", tone: "äº¬éƒ½å¼ã€‚ä¸å¯§ã ãŒè£ã®æ„å‘³ãŒæ€–ã„çš®è‚‰ã€‚" }
        ];

        let genAI = null;
        let model = null;
        let timelineHistory = [];

        window.onload = () => {
            const key = localStorage.getItem("gemini_key");
            if (!key) document.getElementById("apiKeyModal").classList.remove("hidden");
            else initGemini(key);
        };

        window.saveApiKey = () => {
            let key = document.getElementById("apiKeyInput").value.trim(); // ç©ºç™½å‰Šé™¤
            if (key) {
                localStorage.setItem("gemini_key", key);
                document.getElementById("apiKeyModal").classList.add("hidden");
                initGemini(key);
            }
        };

        function initGemini(key) {
            genAI = new GoogleGenerativeAI(key);
            // ã€é‡è¦ã€‘ã“ã“ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨å¥¨ã® 2.0 Flash ã«å¤‰æ›´
            model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-exp" });
        }

        window.generateTweet = async () => {
            const btn = document.getElementById("sendBtn");
            const topic = document.getElementById("topicInput").value || "ç›´å‰ã®ä¼šè©±ã‚’å—ã‘ã¦ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³";
            btn.disabled = true;
            btn.innerText = "æ€è€ƒä¸­...";

            const prompt = `
            SNSã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ã‚­ãƒ£ãƒ©ã‹ã‚‰ã€è©±é¡Œã€Œ${topic}ã€ã«åˆã†1äººã‚’é¸ã³ç™ºè¨€ã•ã›ã¦ãã ã•ã„ã€‚
            å¿…ãšJSONå½¢å¼ { "char_index": æ•°å­—, "content": "æœ¬æ–‡" } ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚Markdownè¨˜å·ã¯ä¸è¦ã€‚
            
            ã‚­ãƒ£ãƒ©: ${JSON.stringify(CHARACTERS)}
            å±¥æ­´: ${timelineHistory.map(t => `${t.name}:${t.content}`).join("|")}
            `;

            try {
                const result = await model.generateContent(prompt);
                const text = result.response.text().replace(/```json|```/g, "").trim();
                const data = JSON.parse(text);
                addTweetToUI(data);
            } catch (e) {
                // ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ç”»é¢ã«å‡ºã™
                alert("ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: " + e.toString());
                if(e.toString().includes("400") || e.toString().includes("key")) {
                    localStorage.removeItem("gemini_key");
                    location.reload();
                }
            }
            btn.disabled = false;
            btn.innerText = "æ¬¡ã¸";
        };

        function addTweetToUI(data) {
            const char = CHARACTERS[data.char_index];
            const tweet = { name: char.name, content: data.content };
            timelineHistory.push(tweet);
            if(timelineHistory.length > 5) timelineHistory.shift();

            const container = document.getElementById("timeline");
            if (container.children[0]?.classList.contains("text-center")) container.innerHTML = "";

            const html = `
                <div class="tweet-card bg-white border border-gray-100 rounded-xl p-4 shadow-sm mb-4">
                    <div class="flex items-center mb-2">
                        <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-xl mr-3">${char.icon}</div>
                        <div><span class="font-bold text-gray-900 mr-2">${char.name}</span><span class="text-xs text-gray-400">@${char.id}</span></div>
                    </div>
                    <div class="text-gray-800 text-sm leading-relaxed">${data.content}</div>
                </div>`;
            container.insertAdjacentHTML('afterbegin', html);
        }

        window.resetTimeline = () => {
            timelineHistory = [];
            document.getElementById("timeline").innerHTML = '<div class="text-center text-gray-500 text-sm mt-10">ãƒªã‚»ãƒƒãƒˆå®Œäº†</div>';
        };
    </script>
</body>
</html>
