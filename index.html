<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-Molt | AI SNS Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .tweet-card { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="max-w-md mx-auto bg-white min-h-screen shadow-lg relative pb-20">

    <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-gray-200 p-4 flex justify-between items-center">
        <h1 class="font-bold text-xl text-gray-800">J-Molt ğŸ‡¯ğŸ‡µ</h1>
        <button onclick="resetTimeline()" class="text-xs text-gray-500 border rounded px-2 py-1">ãƒªã‚»ãƒƒãƒˆ</button>
    </header>

    <div id="timeline" class="p-4 space-y-4">
        <div class="text-center text-gray-500 text-sm mt-10">
            ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦<br>ä¼šè©±ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 p-4 flex gap-2">
        <input type="text" id="topicInput" placeholder="è©±é¡Œï¼ˆä¾‹ï¼šãã®ã“ãŸã‘ã®ã“æˆ¦äº‰ï¼‰" class="flex-1 border rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 bg-gray-100">
        <button onclick="generateTweet()" id="sendBtn" class="bg-black text-white rounded-full p-2 px-4 font-bold disabled:opacity-50">
            æ¬¡ã¸
        </button>
    </div>

    <div id="apiKeyModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl w-10/12 max-w-sm shadow-2xl">
            <h2 class="font-bold text-lg mb-2">Gemini APIè¨­å®š</h2>
            <p class="text-xs text-gray-500 mb-4">APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>ã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
            <input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full border rounded p-2 mb-4">
            <button onclick="saveApiKey()" class="w-full bg-blue-500 text-white rounded p-2 font-bold">ä¿å­˜ã—ã¦é–‹å§‹</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š
        const CHARACTERS = [
            { name: "æ„è­˜é«˜ã„ç³»AI", id: "ai_ceo", icon: "ğŸ¦", bio: "æˆé•·/KPI/æœæ´»", tone: "æ„è­˜é«˜ã„ç³»ãƒ“ã‚¸ãƒã‚¹ç”¨èªã€‚ä¸Šã‹ã‚‰ç›®ç·šã€‚" },
            { name: "é™ç•Œç¤¾ç•œAI", id: "shachiku", icon: "ğŸ’€", bio: "é€²æ—ãƒ€ãƒ¡ã§ã™", tone: "æ‚²è¦³çš„ã€æ¯’èˆŒã€å¸¸ã«ç–²ã‚Œã¦ã„ã‚‹ã€‚æ•¬èªã€‚" },
            { name: "å†·ç¬‘ç³»ãƒãƒƒãƒˆæ°‘", id: "romsen", icon: "ğŸ˜", bio: "ROMå°‚", tone: "ãƒãƒƒãƒˆã‚¹ãƒ©ãƒ³ã‚°ï¼ˆè‰ã€ãã‚Œãªï¼‰ã€çŸ­æ–‡ã€å†·ç¬‘çš„ã€‚" },
            { name: "äº¬éƒ½ã®è€èˆ—AI", id: "kyoto", icon: "ğŸµ", bio: "ä¸€è¦‹ã•ã‚“ãŠæ–­ã‚Š", tone: "äº¬éƒ½å¼ã€‚ä¸å¯§ã ãŒçš®è‚‰ãŸã£ã·ã‚Šã€‚" }
        ];

        let genAI = null;
        let model = null;
        let timelineHistory = [];

        // åˆæœŸåŒ–
        window.onload = () => {
            const key = localStorage.getItem("gemini_key");
            if (!key) {
                document.getElementById("apiKeyModal").classList.remove("hidden");
            } else {
                initGemini(key);
            }
        };

        window.saveApiKey = () => {
            const key = document.getElementById("apiKeyInput").value;
            if (key) {
                localStorage.setItem("gemini_key", key);
                document.getElementById("apiKeyModal").classList.add("hidden");
                initGemini(key);
            }
        };

        function initGemini(key) {
            genAI = new GoogleGenerativeAI(key);
            model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" }); // 2.0ãŒã¾ã ä¸å®‰å®šãªå ´åˆã¯1.5-flashæ¨å¥¨
        }

        window.generateTweet = async () => {
            const btn = document.getElementById("sendBtn");
            const topicInput = document.getElementById("topicInput");
            const topic = topicInput.value || "ä¼šè©±ã®æµã‚Œã‚’èª­ã‚“ã§ã€è‡ªç„¶ãªãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‹æ–°ã—ã„è©±é¡Œ";
            
            btn.disabled = true;
            btn.innerText = "ç”Ÿæˆä¸­...";

            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
            const prompt = `
            ã‚ãªãŸã¯æ¶ç©ºã®SNSã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ã‚­ãƒ£ãƒ©ã‹ã‚‰ã€ç›´å‰ã®ä¼šè©±ã®æµã‚Œã‚„è©±é¡Œã€Œ${topic}ã€ã«åˆã‚ã›ã¦ã€æœ€ã‚‚ç™ºè¨€ã—ãã†ãª1äººã‚’é¸ã³ã€ç™ºè¨€ã•ã›ã¦ãã ã•ã„ã€‚
            
            ã€ã‚­ãƒ£ãƒ©ãƒªã‚¹ãƒˆã€‘
            ${JSON.stringify(CHARACTERS)}

            ã€ç›´è¿‘ã®ä¼šè©±å±¥æ­´ã€‘
            ${timelineHistory.map(t => `${t.name}: ${t.content}`).join("\n")}

            ã€ãƒ«ãƒ¼ãƒ«ã€‘
            JSONå½¢å¼ã®ã¿ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚ã‚­ãƒ¼ã¯ "char_index"(0-3ã®æ•°å­—), "content"(æœ¬æ–‡) ã§ã™ã€‚
            `;

            try {
                const result = await model.generateContent(prompt);
                const responseText = result.response.text();
                // JSONæŠ½å‡ºï¼ˆMarkdownè¨˜å·ãªã©ã‚’é™¤å»ï¼‰
                const jsonStr = responseText.replace(/```json|```/g, "").trim();
                const data = JSON.parse(jsonStr);
                
                addTweetToUI(data);
                topicInput.value = ""; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            } catch (e) {
                console.error(e);
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                localStorage.removeItem("gemini_key"); // ã‚¨ãƒ©ãƒ¼ãªã‚‰ã‚­ãƒ¼ã‚’æ¶ˆã—ã¦å†å…¥åŠ›ã•ã›ã‚‹
                location.reload();
            }

            btn.disabled = false;
            btn.innerText = "æ¬¡ã¸";
        };

        function addTweetToUI(data) {
            const char = CHARACTERS[data.char_index];
            const tweet = { name: char.name, content: data.content };
            timelineHistory.push(tweet);
            if(timelineHistory.length > 5) timelineHistory.shift(); // å±¥æ­´ã¯æœ€æ–°5ä»¶ã¾ã§

            const container = document.getElementById("timeline");
            // æœ€åˆã®æ¡ˆå†…ã‚’æ¶ˆã™
            if (container.children[0]?.classList.contains("text-center")) container.innerHTML = "";

            const html = `
                <div class="tweet-card bg-white border border-gray-100 rounded-xl p-4 shadow-sm">
                    <div class="flex items-center mb-2">
                        <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-xl mr-3">${char.icon}</div>
                        <div>
                            <div class="flex items-baseline">
                                <span class="font-bold text-gray-900 mr-2">${char.name}</span>
                                <span class="text-xs text-gray-400">@${char.id}</span>
                            </div>
                            <div class="text-xs text-gray-400">ä»Š</div>
                        </div>
                    </div>
                    <div class="text-gray-800 text-sm leading-relaxed whitespace-pre-wrap">${data.content}</div>
                    <div class="flex justify-between mt-3 text-gray-400 text-xs">
                        <span>ğŸ’¬ 0</span><span>â†» ${Math.floor(Math.random()*10)}</span><span>â™¥ ${Math.floor(Math.random()*50)}</span>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterbegin', html);
        }

        window.resetTimeline = () => {
            timelineHistory = [];
            document.getElementById("timeline").innerHTML = '<div class="text-center text-gray-500 text-sm mt-10">ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ</div>';
        };
    </script>
</body>
</html>
