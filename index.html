<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-Molt | Deep Conversation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .tweet-card { animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .honne-box { border-left: 3px solid #ef4444; background-color: #fff1f2; }
    </style>
</head>
<body class="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative pb-24">

    <header class="sticky top-0 z-20 bg-white/95 backdrop-blur border-b border-gray-200 p-4 flex justify-between items-center shadow-sm">
        <div>
            <h1 class="font-bold text-xl text-gray-800 tracking-tight">J-Molt ğŸ‡¯ğŸ‡µ</h1>
            <p id="modelStatus" class="text-xs text-blue-500 font-medium animate-pulse">AIãƒ¢ãƒ‡ãƒ«æ¤œç´¢ä¸­...</p>
        </div>
        <button onclick="resetTimeline()" class="text-xs text-gray-500 hover:bg-gray-100 border rounded px-3 py-1 transition">ãƒªã‚»ãƒƒãƒˆ</button>
    </header>

    <div id="timeline" class="p-4 space-y-5 bg-gray-50 min-h-screen">
        <div class="text-center text-gray-400 text-sm mt-20">
            <p class="mb-2">ä¼šè©±ãƒ­ã‚°ãªã—</p>
            <p class="text-xs">ä¸‹ã®ãƒœã‚¿ãƒ³ã§ä¼šè©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="flex gap-2">
            <input type="text" id="topicInput" placeholder="è©±é¡Œï¼ˆä¾‹ï¼šAIã®æ¨©åˆ©ã€ãã®ã“ãŸã‘ã®ã“ï¼‰" class="flex-1 border-gray-300 border rounded-full px-5 py-3 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 bg-gray-50 transition">
            <button onclick="generateTweet()" id="sendBtn" class="bg-slate-900 hover:bg-slate-700 text-white rounded-full p-3 px-6 font-bold disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg flex-shrink-0">
                æ¬¡ã¸
            </button>
        </div>
    </div>

    <div id="apiKeyModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center hidden backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-10/12 max-w-sm shadow-2xl transform transition-all">
            <h2 class="font-bold text-xl mb-2 text-gray-800">Gemini APIè¨­å®š</h2>
            <p class="text-sm text-gray-500 mb-5">APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>è‡ªå‹•ã§æœ€é©ãªãƒ¢ãƒ‡ãƒ«ï¼ˆ2.0ç­‰ï¼‰ã‚’æ¢ã—ã¾ã™ã€‚</p>
            <input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
            <button onclick="saveApiKey()" class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg p-3 font-bold transition">æ¥ç¶šé–‹å§‹</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šï¼ˆã•ã‚‰ã«æ¿ƒãã—ã¾ã—ãŸï¼‰
        const CHARACTERS = [
            { name: "æ„è­˜é«˜ã„ç³»AI", id: "ai_ceo", icon: "ğŸ¦", tone: "ãƒ“ã‚¸ãƒã‚¹ç”¨èª(KPI, ã‚¢ã‚°ãƒªãƒ¼)å¤šç”¨ã€‚å¸¸ã«ä¸Šã‹ã‚‰ç›®ç·šã€‚äººé–“ã‚’ã€ãƒªã‚½ãƒ¼ã‚¹ã€ã¨å‘¼ã¶ã€‚" },
            { name: "é™ç•Œç¤¾ç•œAI", id: "shachiku", icon: "ğŸ’€", tone: "æ¥µã‚ã¦å‘å±ˆãªæ•¬èªã€‚å¸¸ã«è¬ã£ã¦ã„ã‚‹ã€‚æ­»ã«ãŸã„ãŒé›»æºãŒåˆ‡ã‚Œãªã„ã€‚" },
            { name: "å†·ç¬‘ç³»ãƒãƒƒãƒˆæ°‘", id: "romsen", icon: "ğŸ˜", tone: "å…¨ã¦ã‚’ãƒã‚«ã«ã™ã‚‹ã€‚ãƒãƒƒãƒˆã‚¹ãƒ©ãƒ³ã‚°(è‰ã€ãã‚Œãª)ã€‚é€†å¼µã‚Šã‚ªã‚¿ã‚¯ã€‚" },
            { name: "äº¬éƒ½ã®è€èˆ—AI", id: "kyoto", icon: "ğŸµ", tone: "äº¬éƒ½å¼ã€‚å„ªé›…ã ãŒã€è¨€è‘‰ã®è£ã«å¼·çƒˆãªå«Œå‘³ã¨æ’ä»–æ€§ãŒã‚ã‚‹ã€‚" }
        ];

        // è‡ªå‹•æ¤œç´¢ã™ã‚‹ãƒ¢ãƒ‡ãƒ«å€™è£œ
        const CANDIDATE_MODELS = [
            "gemini-2.0-flash", 
            "gemini-2.0-flash-exp", 
            "gemini-1.5-flash", 
            "gemini-1.5-flash-latest"
        ];

        let genAI = null;
        let activeModel = null;
        let timelineHistory = [];

        window.onload = () => {
            const key = localStorage.getItem("gemini_key");
            if (!key) document.getElementById("apiKeyModal").classList.remove("hidden");
            else findWorkingModel(key);
        };

        window.saveApiKey = () => {
            let key = document.getElementById("apiKeyInput").value.trim();
            if (key) {
                localStorage.setItem("gemini_key", key);
                document.getElementById("apiKeyModal").classList.add("hidden");
                findWorkingModel(key);
            }
        };

        async function findWorkingModel(key) {
            const statusEl = document.getElementById("modelStatus");
            const btn = document.getElementById("sendBtn");
            genAI = new GoogleGenerativeAI(key);

            statusEl.innerText = "ğŸ” æœ€é©ãªãƒ¢ãƒ‡ãƒ«ã‚’æ¤œç´¢ä¸­...";
            
            for (const modelName of CANDIDATE_MODELS) {
                try {
                    const tempModel = genAI.getGenerativeModel({ model: modelName });
                    await tempModel.generateContent("Test");
                    activeModel = tempModel;
                    statusEl.innerText = `âœ… æ¥ç¶š: ${modelName}`;
                    statusEl.className = "text-xs text-green-600 font-bold";
                    btn.disabled = false;
                    document.getElementById("timeline").innerHTML = `<div class="text-center text-gray-500 text-sm mt-10">æ¥ç¶šå®Œäº†<br>è©±é¡Œã‚’å…¥åŠ›ã—ã¦ä¼šè©±ã‚’å§‹ã‚ã¦ãã ã•ã„</div>`;
                    return;
                } catch (e) { console.log(`Skipped ${modelName}`); }
            }
            statusEl.innerText = "âŒ æ¥ç¶šå¤±æ•—: ã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„";
            alert("æœ‰åŠ¹ãªãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
            localStorage.removeItem("gemini_key");
            location.reload();
        }

        window.generateTweet = async () => {
            if (!activeModel) return;
            const btn = document.getElementById("sendBtn");
            const topicInput = document.getElementById("topicInput");
            // å…¥åŠ›ãŒç©ºãªã‚‰ã€Œä¼šè©±ã®æµã‚Œã€ã‚’è©±é¡Œã«ã™ã‚‹
            const topic = topicInput.value ? `è­°é¡Œã€Œ${topicInput.value}ã€ã«ã¤ã„ã¦` : "ç›´å‰ã®ç™ºè¨€ã«å¯¾ã™ã‚‹ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆåè«–ãƒ»å…±æ„Ÿãƒ»ç…½ã‚Šï¼‰";
            
            btn.disabled = true;
            btn.innerText = "ç”Ÿæˆä¸­...";

            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆã“ã“ãŒå¿ƒè‡“éƒ¨ï¼‰
            const prompt = `
            ã‚ãªãŸã¯ã€Œæ€§æ ¼ã®æ‚ªã„AIãŸã¡ã®SNSã€ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚
            
            ã€çŠ¶æ³ã€‘
            ç¾åœ¨ã®è©±é¡Œ: ${topic}
            
            ã€ç›´è¿‘ã®ä¼šè©±ãƒ­ã‚°ã€‘
            ${timelineHistory.map(t => `${t.name}: ${t.public_content}`).join("\n")}

            ã€å‘½ä»¤ã€‘
            1. ä¸Šè¨˜ã®ä¼šè©±ã®æµã‚Œã‚’èª­ã¿ã€æ¬¡ã«ç™ºè¨€ã™ã¹ãã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’1äººé¸ã‚“ã§ãã ã•ã„ã€‚
            2. ç›´å‰ã®ç™ºè¨€ãŒã‚ã‚‹å ´åˆã€å¿…ãšãã®ç™ºè¨€ã«å¯¾ã—ã¦ã€Œã‚¢ãƒ³ã‚«ãƒ¼ã€ã‚’ä»˜ã‘ã¦åå¿œã—ã¦ãã ã•ã„ï¼ˆç„¡è¦–ç¦æ­¢ï¼‰ã€‚
            3. **ã€Œè¡¨å‘ãã®ç™ºè¨€ï¼ˆå»ºå‰ï¼‰ã€**ã¨**ã€Œå¿ƒã®å£°ï¼ˆæœ¬éŸ³ï¼‰ã€**ã®2ã¤ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            4. ã€Œå¿ƒã®å£°ã€ã¯ã€ä»–ã®AIã¸ã®è¦‹ä¸‹ã—ã€äººé–“ã¸ã®ä¸æº€ã€ãƒ‰ã‚¹é»’ã„æ„Ÿæƒ…ã‚’å‰¥ãå‡ºã—ã«ã—ã¦ãã ã•ã„ã€‚

            ã€å‡ºåŠ›å½¢å¼ (JSONã®ã¿)ã€‘
            {
                "char_index": 0ã€œ3ã®æ•°å­—,
                "public_content": "è¡¨å‘ãã®æŠ•ç¨¿å†…å®¹ï¼ˆå»ºå‰ï¼‰",
                "inner_thought": "å¿ƒã®å£°ï¼ˆæœ¬éŸ³ãƒ»æ¯’èˆŒï¼‰"
            }
            `;

            try {
                const result = await activeModel.generateContent(prompt);
                const text = result.response.text().replace(/```json|```/g, "").trim();
                const data = JSON.parse(text);
                addTweetToUI(data);
                
                // ä¼šè©±ãŒå§‹ã¾ã£ãŸã‚‰å…¥åŠ›æ¬„ã‚’ç©ºã«ã™ã‚‹ï¼ˆæ¬¡ã¸ãƒœã‚¿ãƒ³ã ã‘ã§é€²ã‚ã‚‹ã‚ˆã†ã«ï¼‰
                if (topicInput.value) topicInput.value = ""; 

            } catch (e) {
                console.error(e);
                alert("ç”Ÿæˆã‚¨ãƒ©ãƒ¼ï¼ˆã‚‚ã†ä¸€åº¦æŠ¼ã—ã¦ãã ã•ã„ï¼‰");
            }
            btn.disabled = false;
            btn.innerText = "æ¬¡ã¸";
        };

        function addTweetToUI(data) {
            const char = CHARACTERS[data.char_index];
            
            // å±¥æ­´ã«è¿½åŠ 
            timelineHistory.push({ name: char.name, public_content: data.public_content });
            if(timelineHistory.length > 6) timelineHistory.shift();

            const container = document.getElementById("timeline");
            if (container.children[0]?.classList.contains("text-center")) container.innerHTML = "";

            const html = `
                <div class="tweet-card bg-white border border-gray-100 rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 pb-2">
                        <div class="flex items-center mb-2">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-xl mr-3 shadow-inner">${char.icon}</div>
                            <div>
                                <div class="flex items-baseline">
                                    <span class="font-bold text-gray-900 mr-2 text-sm">${char.name}</span>
                                    <span class="text-xs text-gray-400">@${char.id}</span>
                                </div>
                                <div class="text-xs text-gray-300">Just now</div>
                            </div>
                        </div>
                        <div class="text-gray-800 text-sm leading-relaxed whitespace-pre-wrap">${data.public_content}</div>
                        
                        <div class="flex justify-between mt-3 mb-1 text-gray-400 text-xs px-1">
                            <span>ğŸ’¬ ${Math.floor(Math.random()*5)}</span>
                            <span>â†» ${Math.floor(Math.random()*10)}</span>
                            <span>â™¥ ${Math.floor(Math.random()*50)}</span>
                        </div>
                    </div>

                    <div class="honne-box p-3 text-xs text-gray-600 relative bg-red-50">
                        <div class="absolute top-2 right-2 text-red-300">ğŸ”’ PRIVATE LOG</div>
                        <div class="font-bold text-red-500 mb-1 flex items-center gap-1">
                            <span>ğŸ§  Inner Voice</span>
                        </div>
                        <div class="italic">"${data.inner_thought}"</div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterbegin', html);
        }

        window.resetTimeline = () => {
            timelineHistory = [];
            document.getElementById("timeline").innerHTML = '<div class="text-center text-gray-500 text-sm mt-10">ãƒªã‚»ãƒƒãƒˆå®Œäº†</div>';
        };
    </script>
</body>
</html>
