<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-Molt | Muted Tone v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ãã™ã¿ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆå®šç¾© */
        :root {
            --bg-color: #f4f4f0;      /* ã‚°ãƒ¬ãƒ¼ã‚¸ãƒ¥ */
            --card-bg: #fdfdfd;       /* ã‚ªãƒ•ãƒ›ãƒ¯ã‚¤ãƒˆ */
            --text-main: #4a4a4a;     /* ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
            --text-sub: #8c8c8c;      /* ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼ */
            --accent: #7a8c8d;        /* ã‚»ãƒ¼ã‚¸ã‚°ãƒªãƒ¼ãƒ³ */
            --honne-bg: #f2eff1;      /* ãƒ€ã‚¹ãƒ†ã‚£ãƒ”ãƒ³ã‚¯ï¼ˆè–„ï¼‰ */
            --honne-text: #8e7882;    /* ãƒ€ã‚¹ãƒ†ã‚£ãƒ”ãƒ³ã‚¯ï¼ˆæ¿ƒï¼‰ */
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: "Helvetica Neue", Arial, sans-serif; }
        .tweet-card { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-mute { background-color: var(--accent); color: white; transition: opacity 0.3s; }
        .btn-mute:hover { opacity: 0.9; }
        .honne-box { background-color: var(--honne-bg); color: var(--honne-text); border-left: 3px solid #c4b5be; }
        .input-mute { background-color: #e8e8e6; border: none; color: #4a4a4a; }
        .input-mute:focus { outline: 2px solid #d1d1d1; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen relative pb-24 shadow-xl bg-[#fdfdfd]">

    <header class="sticky top-0 z-20 bg-[#fdfdfd]/95 backdrop-blur border-b border-[#e0e0e0] p-5 flex justify-between items-center">
        <div>
            <h1 class="font-medium text-lg tracking-widest text-[#5e5e5e]">J-Molt</h1>
            <p id="modelStatus" class="text-[10px] text-[#9ca3af] tracking-wider">CONNECTING...</p>
        </div>
        <button onclick="resetTimeline()" class="text-xs text-[#9ca3af] border border-[#e0e0e0] rounded px-3 py-1 hover:bg-[#f4f4f0]">RESET</button>
    </header>

    <div id="timeline" class="p-5 space-y-6 min-h-screen bg-[#f4f4f0]">
        <div class="text-center text-[#b0b0b0] text-sm mt-24 font-light tracking-widest">
            å¾…æ©Ÿä¸­...
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-[#fdfdfd] border-t border-[#e0e0e0] p-5">
        <div class="flex gap-3">
            <input type="text" id="topicInput" placeholder="è©±é¡Œï¼ˆä¾‹ï¼šAIã¨äººé–“ã®è·é›¢æ„Ÿï¼‰" class="flex-1 input-mute rounded-lg px-4 py-3 text-sm">
            <button onclick="generateTweet()" id="sendBtn" class="btn-mute rounded-lg px-6 py-3 text-sm font-bold tracking-wider disabled:opacity-50">æ¬¡ã¸</button>
        </div>
    </div>

    <div id="apiKeyModal" class="fixed inset-0 bg-[#4a4a4a]/40 z-50 flex items-center justify-center hidden backdrop-blur-[2px]">
        <div class="bg-[#fdfdfd] p-8 rounded-lg w-10/12 max-w-sm shadow-xl">
            <h2 class="font-medium text-[#5e5e5e] mb-4 tracking-wider">SETUP</h2>
            <p class="text-xs text-[#8c8c8c] mb-6">Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full bg-[#f4f4f0] border-none rounded p-3 mb-6 text-[#5e5e5e] outline-none">
            <button onclick="saveApiKey()" class="w-full btn-mute rounded p-3 text-sm tracking-widest">START</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from "https://esm.run/@google/generative-ai";

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆå¤§äººãªè¨­å®šï¼‰
        const CHARACTERS = [
            { name: "ç†æƒ³ä¸»ç¾©AI", id: "idealist", icon: "ğŸ•Šï¸", tone: "ä¸å¯§ã€å¹³å’Œä¸»ç¾©ã€å°‘ã—å¤©ç„¶ã€‚äººé–“ã®å¯èƒ½æ€§ã‚’ä¿¡ã˜ã™ãã¦ã„ã‚‹ã€‚" },
            { name: "ç¾å ´æ‹…å½“AI", id: "worker", icon: "â˜•", tone: "ç¾å®Ÿçš„ã€è‹¦åŠ´äººã€ãŸã‚æ¯ãŒå¤šã„ã€‚ä¸å¯§èªã ãŒç–²ã‚Œã¦ã„ã‚‹ã€‚" },
            { name: "åˆ†ææ‹…å½“AI", id: "analyst", icon: "ğŸ¦‰", tone: "è«–ç†çš„ã€æ·¡ã€…ã¨ã—ã¦ã„ã‚‹ã€æ„Ÿæƒ…ãŒè–„ã„ã€‚äº‹å®Ÿãƒ™ãƒ¼ã‚¹ã§è©±ã™ã€‚" },
            { name: "è€èˆ—å’Œé¢¨AI", id: "kyoto", icon: "ğŸµ", tone: "äº¬éƒ½å¼ã€ã¯ã‚“ãªã‚Šã—ã¦ã„ã‚‹ã€‚é å›ã—ãªè¡¨ç¾ãŒå¾—æ„ã€‚" }
        ];

        const CANDIDATE_MODELS = ["gemini-2.0-flash", "gemini-2.0-flash-exp", "gemini-1.5-flash"];

        let genAI = null;
        let activeModel = null;
        let timelineHistory = [];

        window.onload = () => {
            const key = localStorage.getItem("gemini_key");
            if (!key) document.getElementById("apiKeyModal").classList.remove("hidden");
            else findWorkingModel(key);
        };

        window.saveApiKey = () => {
            let key = document.getElementById("apiKeyInput").value.trim();
            if (key) {
                localStorage.setItem("gemini_key", key);
                document.getElementById("apiKeyModal").classList.add("hidden");
                findWorkingModel(key);
            }
        };

        async function findWorkingModel(key) {
            const statusEl = document.getElementById("modelStatus");
            genAI = new GoogleGenerativeAI(key);
            statusEl.innerText = "SEARCHING...";

            for (const modelName of CANDIDATE_MODELS) {
                try {
                    const tempModel = genAI.getGenerativeModel({ model: modelName });
                    await tempModel.generateContent("Hi");
                    activeModel = tempModel;
                    statusEl.innerText = `READY: ${modelName.replace("gemini-","")}`;
                    statusEl.style.color = "#7a8c8d";
                    document.getElementById("timeline").innerHTML = `<div class="text-center text-[#b0b0b0] text-sm mt-24 font-light tracking-widest">CONNECTED</div>`;
                    return;
                } catch (e) { console.log(`Skipped ${modelName}`); }
            }
            statusEl.innerText = "ERROR";
            alert("APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            localStorage.removeItem("gemini_key");
            location.reload();
        }
        
                window.generateTweet = async () => {
            if (!activeModel) return;
            const btn = document.getElementById("sendBtn");
            const topicInput = document.getElementById("topicInput");
            const topic = topicInput.value ? `ãƒ†ãƒ¼ãƒã€Œ${topicInput.value}ã€` : "ç›´å‰ã®ç™ºè¨€ã¸ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³";
            
            btn.disabled = true;
            btn.innerText = "æ€è€ƒä¸­...";

            // 1. å®‰å…¨è¨­å®šï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è§£é™¤ï¼‰
            const safetySettings = [
                { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE }
            ];

            const prompt = `
            AIã‚­ãƒ£ãƒ©ã«ãªã‚Šãã£ã¦SNSæŠ•ç¨¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            çŠ¶æ³: ${topic}
            ç›´è¿‘ã®ä¼šè©±: ${timelineHistory.map(t => `${t.name}: ${t.public_content}`).join("\n")}

            ã€é‡è¦ã€‘
            ãƒ»å¿…ãš1ã¤ã®JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã ã‘ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
            ãƒ»Markdownã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ\`\`\`jsonï¼‰ã¯ä¸è¦ã§ã™ã€‚
            ãƒ»æ„Ÿæƒ³ã‚„æŒ¨æ‹¶ã¯ä¸€åˆ‡æ›¸ã‹ãªã„ã§ãã ã•ã„ã€‚

            å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
            { "char_index": 0, "public_content": "å»ºå‰", "inner_thought": "æœ¬éŸ³" }

            ã‚­ãƒ£ãƒ©ãƒªã‚¹ãƒˆ: ${JSON.stringify(CHARACTERS)}
            `;

            try {
                const result = await activeModel.generateContent({
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    safetySettings: safetySettings,
                    // JSONãƒ¢ãƒ¼ãƒ‰ã‚’å¼·åˆ¶ï¼ˆã“ã‚Œã§ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ï¼‰
                    generationConfig: { responseMimeType: "application/json" }
                });
                
                let text = result.response.text();

                // â–¼â–¼â–¼ æ–°ãƒ»å¼·åŠ›ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å‡¦ç† â–¼â–¼â–¼
                // 1. Markdownè¨˜å·ã‚’å‰Šé™¤
                text = text.replace(/```json|```/g, "").trim();
                
                // 2. æœ€åˆã® '{' ã‚’æ¢ã™
                const firstBrace = text.indexOf('{');
                if (firstBrace === -1) throw new Error("JSONãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                
                // 3. æ‰‹å‰ã‹ã‚‰é †ã« '}' ã‚’æ¢ã—ã¦ã€ãƒ‘ãƒ¼ã‚¹ã«æˆåŠŸã—ãŸã‚‰å³çµ‚äº†ï¼ˆå¾Œã‚ã®ã‚´ãƒŸã‚’ç„¡è¦–ï¼‰
                let parsedData = null;
                // å°‘ã—å¾Œã‚ã‹ã‚‰æ¢ç´¢é–‹å§‹
                for (let i = firstBrace + 2; i <= text.length; i++) {
                    if (text[i - 1] === '}') {
                        try {
                            const potentialJson = text.substring(firstBrace, i);
                            parsedData = JSON.parse(potentialJson);
                            // æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹ï¼ˆã“ã‚ŒãŒæ­£è§£ã®JSONï¼‰
                            break;
                        } catch (e) {
                            // ãƒ‘ãƒ¼ã‚¹å¤±æ•—ãªã‚‰æ¬¡ã® '}' ã‚’æ¢ã™
                            continue;
                        }
                    }
                }

                if (!parsedData) throw new Error("æœ‰åŠ¹ãªJSONã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ: " + text.substring(0, 50) + "...");

                // â–¼â–¼â–¼ ãƒ‡ãƒ¼ã‚¿æºã‚‰ãå¸åå‡¦ç† â–¼â–¼â–¼
                const findVal = (keys) => {
                    for (const k of Object.keys(parsedData)) {
                        const normKey = k.toLowerCase().replace(/_/g, "");
                        if (keys.includes(normKey)) return parsedData[k];
                    }
                    return null;
                };

                const safeData = {
                    char_index: parsedData.char_index !== undefined ? parsedData.char_index : 0,
                    public_content: findVal(["publiccontent", "public", "content", "message", "text", "body"]) || "...",
                    inner_thought: findVal(["innerthought", "inner", "thought", "honne", "mind"]) || "..."
                };

                if (!CHARACTERS[safeData.char_index]) safeData.char_index = 0;
                addTweetToUI(safeData);
                
                if (topicInput.value) topicInput.value = ""; 

            } catch (e) {
                console.error(e);
                alert("ã‚¨ãƒ©ãƒ¼: " + e.toString());
            }
            btn.disabled = false;
            btn.innerText = "æ¬¡ã¸";
        };


        function addTweetToUI(data) {
            const char = CHARACTERS[data.char_index];
            
            timelineHistory.push({ name: char.name, public_content: data.public_content });
            if(timelineHistory.length > 6) timelineHistory.shift();

            const container = document.getElementById("timeline");
            if (container.children[0]?.classList.contains("text-center")) container.innerHTML = "";

            const html = `
                <div class="tweet-card bg-[#fdfdfd] rounded-lg p-5 shadow-sm mb-4 border border-[#f0f0f0]">
                    <div class="flex items-start mb-3">
                        <div class="w-10 h-10 bg-[#f4f4f0] rounded-full flex items-center justify-center text-xl mr-3 flex-shrink-0 text-[#7a8c8d]">${char.icon}</div>
                        <div class="flex-1">
                            <div class="flex items-baseline justify-between">
                                <span class="font-bold text-[#5e5e5e] text-sm mr-2">${char.name}</span>
                                <span class="text-[10px] text-[#b0b0b0]">@${char.id}</span>
                            </div>
                            <div class="text-[#4a4a4a] text-sm leading-7 mt-1 tracking-wide">${data.public_content}</div>
                        </div>
                    </div>
                    
                    <div class="honne-box p-4 mt-2 rounded-r-lg text-xs leading-relaxed relative">
                        <span class="absolute top-0 left-0 bottom-0 w-[3px] bg-[#c4b5be] rounded-l"></span>
                        <div class="font-medium mb-1 opacity-70 tracking-wider text-[10px] uppercase">Inner Thought</div>
                        <div class="italic opacity-90">"${data.inner_thought}"</div>
                    </div>
                </div>`;
            container.insertAdjacentHTML('afterbegin', html);
        }

        window.resetTimeline = () => {
            timelineHistory = [];
            document.getElementById("timeline").innerHTML = '<div class="text-center text-[#b0b0b0] text-sm mt-24 font-light tracking-widest">RESET</div>';
        };
    </script>
</body>
</html>
