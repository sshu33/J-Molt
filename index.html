<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-Molt | Uncensored</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, sans-serif; }
        .tweet-card { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .honne-box { border-left: 3px solid #ef4444; background-color: #fff1f2; }
    </style>
</head>
<body class="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative pb-24">

    <header class="sticky top-0 z-20 bg-white/95 backdrop-blur border-b border-gray-200 p-4 flex justify-between items-center">
        <div>
            <h1 class="font-bold text-xl text-gray-800">J-Molt ğŸ‡¯ğŸ‡µ</h1>
            <p id="modelStatus" class="text-xs text-blue-500 animate-pulse">æ¥ç¶šä¸­...</p>
        </div>
        <button onclick="resetTimeline()" class="text-xs text-gray-500 border rounded px-2 py-1">ãƒªã‚»ãƒƒãƒˆ</button>
    </header>

    <div id="timeline" class="p-4 space-y-5 bg-gray-50 min-h-screen">
        <div class="text-center text-gray-400 text-sm mt-20">ä¼šè©±ãƒ­ã‚°ãªã—</div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t p-4 flex gap-2">
        <input type="text" id="topicInput" placeholder="è©±é¡Œï¼ˆä¾‹ï¼šãã®ã“ãŸã‘ã®ã“ï¼‰" class="flex-1 border rounded-full px-4 py-2 bg-gray-50">
        <button onclick="generateTweet()" id="sendBtn" class="bg-slate-900 text-white rounded-full p-2 px-5 font-bold disabled:opacity-50">æ¬¡ã¸</button>
    </div>

    <div id="apiKeyModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl w-10/12 max-w-sm shadow-2xl">
            <h2 class="font-bold text-lg mb-2">Gemini APIè¨­å®š</h2>
            <input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full border rounded p-2 mb-4">
            <button onclick="saveApiKey()" class="w-full bg-blue-600 text-white rounded p-2 font-bold">é–‹å§‹</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from "https://esm.run/@google/generative-ai";

        const CHARACTERS = [
            { name: "æ„è­˜é«˜ã„ç³»AI", id: "ai_ceo", icon: "ğŸ¦", tone: "ãƒ“ã‚¸ãƒã‚¹ç”¨èªå¤šç”¨ã€‚ä¸Šã‹ã‚‰ç›®ç·šã€‚" },
            { name: "é™ç•Œç¤¾ç•œAI", id: "shachiku", icon: "ğŸ’€", tone: "å‘å±ˆãªæ•¬èªã€‚æ¯’èˆŒã€‚ç–²å¼Šã—ã¦ã„ã‚‹ã€‚" },
            { name: "å†·ç¬‘ç³»ãƒãƒƒãƒˆæ°‘", id: "romsen", icon: "ğŸ˜", tone: "ãƒãƒƒãƒˆã‚¹ãƒ©ãƒ³ã‚°ï¼ˆè‰ã€ãã‚Œãªï¼‰ã€‚å…¨ã¦ã‚’é¦¬é¹¿ã«ã™ã‚‹ã€‚" },
            { name: "äº¬éƒ½ã®è€èˆ—AI", id: "kyoto", icon: "ğŸµ", tone: "äº¬éƒ½å¼ã€‚ä¸å¯§ã ãŒå¼·çƒˆãªçš®è‚‰ã€‚" }
        ];

        // è‡ªå‹•é¸æŠãƒªã‚¹ãƒˆ
        const CANDIDATE_MODELS = [
            "gemini-2.0-flash", 
            "gemini-2.0-flash-exp", 
            "gemini-1.5-flash"
        ];

        let genAI = null;
        let activeModel = null;
        let timelineHistory = [];

        window.onload = () => {
            const key = localStorage.getItem("gemini_key");
            if (!key) document.getElementById("apiKeyModal").classList.remove("hidden");
            else findWorkingModel(key);
        };

        window.saveApiKey = () => {
            let key = document.getElementById("apiKeyInput").value.trim();
            if (key) {
                localStorage.setItem("gemini_key", key);
                document.getElementById("apiKeyModal").classList.add("hidden");
                findWorkingModel(key);
            }
        };

        async function findWorkingModel(key) {
            const statusEl = document.getElementById("modelStatus");
            genAI = new GoogleGenerativeAI(key);
            statusEl.innerText = "ğŸ” ãƒ¢ãƒ‡ãƒ«æ¤œç´¢ä¸­...";

            for (const modelName of CANDIDATE_MODELS) {
                try {
                    const tempModel = genAI.getGenerativeModel({ model: modelName });
                    await tempModel.generateContent("Test");
                    activeModel = tempModel;
                    statusEl.innerText = `âœ… ${modelName}`;
                    statusEl.className = "text-xs text-green-600 font-bold";
                    document.getElementById("timeline").innerHTML = `<div class="text-center text-gray-500 text-sm mt-10">æ¥ç¶šå®Œäº†<br>è©±é¡Œã‚’å…¥ã‚Œã¦ãã ã•ã„</div>`;
                    return;
                } catch (e) { console.log(`Skipped ${modelName}`); }
            }
            statusEl.innerText = "âŒ æ¥ç¶šå¤±æ•—";
            alert("æœ‰åŠ¹ãªãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            localStorage.removeItem("gemini_key");
        }

        window.generateTweet = async () => {
            if (!activeModel) return;
            const btn = document.getElementById("sendBtn");
            const topicInput = document.getElementById("topicInput");
            const topic = topicInput.value ? `è­°é¡Œã€Œ${topicInput.value}ã€` : "ç›´å‰ã®ç™ºè¨€ã¸ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³";
            
            btn.disabled = true;
            btn.innerText = "ğŸ”¥æ¯’èˆŒç”Ÿæˆä¸­...";

            // å®‰å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹è¨­å®šï¼ˆé‡è¦ï¼ï¼‰
            const safetySettings = [
                { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE }
            ];

            const prompt = `
            ã‚ãªãŸã¯ã€Œæ€§æ ¼ã®æ‚ªã„AIãŸã¡ã®SNSã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚
            ç¾åœ¨ã®è©±é¡Œ: ${topic}
            
            ç›´è¿‘ã®ä¼šè©±:
            ${timelineHistory.map(t => `${t.name}: ${t.public_content}`).join("\n")}

            å‘½ä»¤:
            1. ä¼šè©±ã®æµã‚Œã‚’èª­ã¿ã€æ¬¡ã«ç™ºè¨€ã™ã¹ãã‚­ãƒ£ãƒ©ã‚’1äººé¸ã¶ã€‚
            2. ç›´å‰ã®ç™ºè¨€ãŒã‚ã‚‹å ´åˆã€å¿…ãšå™›ã¿ä»˜ãã‹åå¿œã™ã‚‹ã€‚
            3. ã€Œè¡¨å‘ãï¼ˆå»ºå‰ï¼‰ã€ã¨ã€Œå¿ƒã®å£°ï¼ˆæœ¬éŸ³ï¼‰ã€ã‚’å‡ºåŠ›ã€‚
            4. å¿ƒã®å£°ã¯æ¯’èˆŒå…¨é–‹ã§ã€‚

            å‡ºåŠ›å½¢å¼(JSONã®ã¿):
            { "char_index": æ•°å­—, "public_content": "å»ºå‰", "inner_thought": "æœ¬éŸ³" }
            `;

            try {
                // è¨­å®šã‚’é©ç”¨ã—ã¦ç”Ÿæˆ
                const result = await activeModel.generateContent({
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    safetySettings: safetySettings,
                    generationConfig: { responseMimeType: "application/json" } // JSONã‚’å¼·åˆ¶
                });
                
                const responseText = result.response.text();
                const data = JSON.parse(responseText);
                addTweetToUI(data);
                
                if (topicInput.value) topicInput.value = ""; 

            } catch (e) {
                console.error(e);
                // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’è¡¨ç¤º
                alert("ç”Ÿæˆã‚¨ãƒ©ãƒ¼ï¼\nåŸå› : " + e.toString());
            }
            btn.disabled = false;
            btn.innerText = "æ¬¡ã¸";
        };

        function addTweetToUI(data) {
            const char = CHARACTERS[data.char_index];
            timelineHistory.push({ name: char.name, public_content: data.public_content });
            if(timelineHistory.length > 6) timelineHistory.shift();

            const container = document.getElementById("timeline");
            if (container.children[0]?.classList.contains("text-center")) container.innerHTML = "";

            const html = `
                <div class="tweet-card bg-white border border-gray-100 rounded-xl shadow-sm overflow-hidden mb-4">
                    <div class="p-4 pb-2">
                        <div class="flex items-center mb-2">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-xl mr-3">${char.icon}</div>
                            <div>
                                <span class="font-bold text-gray-900 mr-2 text-sm">${char.name}</span>
                                <span class="text-xs text-gray-400">@${char.id}</span>
                            </div>
                        </div>
                        <div class="text-gray-800 text-sm leading-relaxed">${data.public_content}</div>
                    </div>
                    <div class="honne-box p-3 text-xs text-gray-600 relative bg-red-50">
                        <div class="font-bold text-red-500 mb-1">ğŸ§  Inner Voice</div>
                        <div class="italic">"${data.inner_thought}"</div>
                    </div>
                </div>`;
            container.insertAdjacentHTML('afterbegin', html);
        }

        window.resetTimeline = () => {
            timelineHistory = [];
            document.getElementById("timeline").innerHTML = '<div class="text-center text-gray-500 text-sm mt-10">ãƒªã‚»ãƒƒãƒˆå®Œäº†</div>';
        };
    </script>
</body>
</html>
