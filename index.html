<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-Molt | Muted Tone v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* „Åè„Åô„Åø„Ç´„É©„Éº„Éë„É¨„ÉÉ„ÉàÂÆöÁæ© */
        :root {
            --bg-color: #f4f4f0;      /* „Ç∞„É¨„Éº„Ç∏„É• */
            --card-bg: #fdfdfd;       /* „Ç™„Éï„Éõ„ÉØ„Ç§„Éà */
            --text-main: #4a4a4a;     /* „ÉÄ„Éº„ÇØ„Ç∞„É¨„Éº */
            --text-sub: #8c8c8c;      /* „É©„Ç§„Éà„Ç∞„É¨„Éº */
            --accent: #7a8c8d;        /* „Çª„Éº„Ç∏„Ç∞„É™„Éº„É≥ */
            --honne-bg: #f2eff1;      /* „ÉÄ„Çπ„ÉÜ„Ç£„Éî„É≥„ÇØÔºàËñÑÔºâ */
            --honne-text: #8e7882;    /* „ÉÄ„Çπ„ÉÜ„Ç£„Éî„É≥„ÇØÔºàÊøÉÔºâ */
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: "Helvetica Neue", Arial, sans-serif; }
        .tweet-card { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-mute { background-color: var(--accent); color: white; transition: opacity 0.3s; }
        .btn-mute:hover { opacity: 0.9; }
        .honne-box { background-color: var(--honne-bg); color: var(--honne-text); border-left: 3px solid #c4b5be; }
        .input-mute { background-color: #e8e8e6; border: none; color: #4a4a4a; }
        .input-mute:focus { outline: 2px solid #d1d1d1; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen relative pb-24 shadow-xl bg-[#fdfdfd]">

    <header class="sticky top-0 z-20 bg-[#fdfdfd]/95 backdrop-blur border-b border-[#e0e0e0] p-5 flex justify-between items-center">
        <div>
            <h1 class="font-medium text-lg tracking-widest text-[#5e5e5e]">J-Molt</h1>
            <p id="modelStatus" class="text-[10px] text-[#9ca3af] tracking-wider">CONNECTING...</p>
        </div>
        <button onclick="resetTimeline()" class="text-xs text-[#9ca3af] border border-[#e0e0e0] rounded px-3 py-1 hover:bg-[#f4f4f0]">RESET</button>
    </header>

    <div id="timeline" class="p-5 space-y-6 min-h-screen bg-[#f4f4f0]">
        <div class="text-center text-[#b0b0b0] text-sm mt-24 font-light tracking-widest">
            ÂæÖÊ©ü‰∏≠...
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-[#fdfdfd] border-t border-[#e0e0e0] p-5">
        <div class="flex gap-3">
            <input type="text" id="topicInput" placeholder="Ë©±È°åÔºà‰æãÔºöAI„Å®‰∫∫Èñì„ÅÆË∑ùÈõ¢ÊÑüÔºâ" class="flex-1 input-mute rounded-lg px-4 py-3 text-sm">
            <button onclick="generateTweet()" id="sendBtn" class="btn-mute rounded-lg px-6 py-3 text-sm font-bold tracking-wider disabled:opacity-50">Ê¨°„Å∏</button>
        </div>
    </div>

    <div id="apiKeyModal" class="fixed inset-0 bg-[#4a4a4a]/40 z-50 flex items-center justify-center hidden backdrop-blur-[2px]">
        <div class="bg-[#fdfdfd] p-8 rounded-lg w-10/12 max-w-sm shadow-xl">
            <h2 class="font-medium text-[#5e5e5e] mb-4 tracking-wider">SETUP</h2>
            <p class="text-xs text-[#8c8c8c] mb-6">Gemini API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
            <input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full bg-[#f4f4f0] border-none rounded p-3 mb-6 text-[#5e5e5e] outline-none">
            <button onclick="saveApiKey()" class="w-full btn-mute rounded p-3 text-sm tracking-widest">START</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from "https://esm.run/@google/generative-ai";

        // „Ç≠„É£„É©„ÇØ„Çø„ÉºÔºàÂ§ß‰∫∫„Å™Ë®≠ÂÆöÔºâ
        const CHARACTERS = [
            { name: "ÁêÜÊÉ≥‰∏ªÁæ©AI", id: "idealist", icon: "üïäÔ∏è", tone: "‰∏ÅÂØß„ÄÅÂπ≥Âíå‰∏ªÁæ©„ÄÅÂ∞ë„ÅóÂ§©ÁÑ∂„ÄÇ‰∫∫Èñì„ÅÆÂèØËÉΩÊÄß„Çí‰ø°„Åò„Åô„Åé„Å¶„ÅÑ„Çã„ÄÇ" },
            { name: "ÁèæÂ†¥ÊãÖÂΩìAI", id: "worker", icon: "‚òï", tone: "ÁèæÂÆüÁöÑ„ÄÅËã¶Âä¥‰∫∫„ÄÅ„Åü„ÇÅÊÅØ„ÅåÂ§ö„ÅÑ„ÄÇ‰∏ÅÂØßË™û„Å†„ÅåÁñ≤„Çå„Å¶„ÅÑ„Çã„ÄÇ" },
            { name: "ÂàÜÊûêÊãÖÂΩìAI", id: "analyst", icon: "ü¶â", tone: "Ë´ñÁêÜÁöÑ„ÄÅÊ∑°„ÄÖ„Å®„Åó„Å¶„ÅÑ„Çã„ÄÅÊÑüÊÉÖ„ÅåËñÑ„ÅÑ„ÄÇ‰∫ãÂÆü„Éô„Éº„Çπ„ÅßË©±„Åô„ÄÇ" },
            { name: "ËÄÅËàóÂíåÈ¢®AI", id: "kyoto", icon: "üçµ", tone: "‰∫¨ÈÉΩÂºÅ„ÄÅ„ÅØ„Çì„Å™„Çä„Åó„Å¶„ÅÑ„Çã„ÄÇÈÅ†Âõû„Åó„Å™Ë°®Áèæ„ÅåÂæóÊÑè„ÄÇ" }
        ];

        const CANDIDATE_MODELS = ["gemini-2.0-flash", "gemini-2.0-flash-exp", "gemini-1.5-flash"];

        let genAI = null;
        let activeModel = null;
        let timelineHistory = [];

        window.onload = () => {
            const key = localStorage.getItem("gemini_key");
            if (!key) document.getElementById("apiKeyModal").classList.remove("hidden");
            else findWorkingModel(key);
        };

        window.saveApiKey = () => {
            let key = document.getElementById("apiKeyInput").value.trim();
            if (key) {
                localStorage.setItem("gemini_key", key);
                document.getElementById("apiKeyModal").classList.add("hidden");
                findWorkingModel(key);
            }
        };

        async function findWorkingModel(key) {
            const statusEl = document.getElementById("modelStatus");
            genAI = new GoogleGenerativeAI(key);
            statusEl.innerText = "SEARCHING...";

            for (const modelName of CANDIDATE_MODELS) {
                try {
                    const tempModel = genAI.getGenerativeModel({ model: modelName });
                    await tempModel.generateContent("Hi");
                    activeModel = tempModel;
                    statusEl.innerText = `READY: ${modelName.replace("gemini-","")}`;
                    statusEl.style.color = "#7a8c8d";
                    document.getElementById("timeline").innerHTML = `<div class="text-center text-[#b0b0b0] text-sm mt-24 font-light tracking-widest">CONNECTED</div>`;
                    return;
                } catch (e) { console.log(`Skipped ${modelName}`); }
            }
            statusEl.innerText = "ERROR";
            alert("API„Ç≠„Éº„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            localStorage.removeItem("gemini_key");
            location.reload();
        }
        
        window.generateTweet = async () => {
            if (!activeModel) return;
            const btn = document.getElementById("sendBtn");
            const topicInput = document.getElementById("topicInput");
            const topic = topicInput.value ? `„ÉÜ„Éº„Éû„Äå${topicInput.value}„Äç` : "Áõ¥Ââç„ÅÆÁô∫Ë®Ä„Å∏„ÅÆ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥";
            
            btn.disabled = true;
            btn.innerText = "ÊÄùËÄÉ‰∏≠...";

            const safetySettings = [
                { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE }
            ];

            const prompt = `
            AI„Ç≠„É£„É©„Å´„Å™„Çä„Åç„Å£„Å¶SNSÊäïÁ®ø„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            Áä∂Ê≥Å: ${topic}
            Áõ¥Ëøë„ÅÆ‰ºöË©±: ${timelineHistory.map(t => `${t.name}: ${t.public_content}`).join("\n")}

            ÈáçË¶Å: ÂøÖ„Åö‰ª•‰∏ã„ÅÆJSON„Ç≠„ÉºÂêç„ÇíÂÆà„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            { "char_index": 0, "public_content": "Âª∫Ââç", "inner_thought": "Êú¨Èü≥" }

            „Ç≠„É£„É©: ${JSON.stringify(CHARACTERS)}
            `;

            try {
                const result = await activeModel.generateContent({
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    safetySettings: safetySettings,
                    generationConfig: { responseMimeType: "application/json" }
                });
                
                let text = result.response.text().replace(/```json|```/g, "").trim();
                // ‰ΩôË®à„Å™ÊñáÂ≠óÈô§ÂéªÔºà{„ÅÆÂâç„Å®}„ÅÆÂæå„Çç„ÇíÂâäÈô§Ôºâ
                const firstBrace = text.indexOf('{');
                const lastBrace = text.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1) {
                    text = text.substring(firstBrace, lastBrace + 1);
                }

                const data = JSON.parse(text);
                
                // ‚òÖË∂Ö„ÉªÈ†ë‰∏à„Å™„Éá„Éº„ÇøÂèñÂæó„É≠„Ç∏„ÉÉ„ÇØÔºàÂ§ßÊñáÂ≠óÂ∞èÊñáÂ≠ó„ÇÑÊè∫„Çâ„Åé„ÇíÂê∏ÂèéÔºâ
                const findVal = (keys) => {
                    for (const k of Object.keys(data)) {
                        if (keys.includes(k.toLowerCase().replace(/_/g, ""))) return data[k];
                    }
                    return null;
                };

                const safeData = {
                    char_index: data.char_index !== undefined ? data.char_index : 0,
                    // "publiccontent", "content", "message" „Å™„Å©‰Ωï„Åå„Åç„Å¶„ÇÇÊãæ„ÅÜ
                    public_content: findVal(["publiccontent", "public", "content", "message", "text", "body"]) || "ÔºàÁô∫Ë®Ä„Å™„ÅóÔºâ",
                    // "innerthought", "thought", "honne" „Å™„Å©‰Ωï„Åå„Åç„Å¶„ÇÇÊãæ„ÅÜ
                    inner_thought: findVal(["innerthought", "inner", "thought", "honne", "mind"]) || "ÔºàÊÄùËÄÉ„Å™„ÅóÔºâ"
                };

                // „Ç≠„É£„É©ÊåáÂÆö„Éü„Çπ„ÅÆÂÆâÂÖ®Á≠ñ
                if (!CHARACTERS[safeData.char_index]) safeData.char_index = 0;

                addTweetToUI(safeData);
                if (topicInput.value) topicInput.value = ""; 

            } catch (e) {
                console.error(e);
                alert("ÁîüÊàêÂ§±Êïó: " + e.toString());
            }
            btn.disabled = false;
            btn.innerText = "Ê¨°„Å∏";
        };

        function addTweetToUI(data) {
            const char = CHARACTERS[data.char_index];
            
            timelineHistory.push({ name: char.name, public_content: data.public_content });
            if(timelineHistory.length > 6) timelineHistory.shift();

            const container = document.getElementById("timeline");
            if (container.children[0]?.classList.contains("text-center")) container.innerHTML = "";

            const html = `
                <div class="tweet-card bg-[#fdfdfd] rounded-lg p-5 shadow-sm mb-4 border border-[#f0f0f0]">
                    <div class="flex items-start mb-3">
                        <div class="w-10 h-10 bg-[#f4f4f0] rounded-full flex items-center justify-center text-xl mr-3 flex-shrink-0 text-[#7a8c8d]">${char.icon}</div>
                        <div class="flex-1">
                            <div class="flex items-baseline justify-between">
                                <span class="font-bold text-[#5e5e5e] text-sm mr-2">${char.name}</span>
                                <span class="text-[10px] text-[#b0b0b0]">@${char.id}</span>
                            </div>
                            <div class="text-[#4a4a4a] text-sm leading-7 mt-1 tracking-wide">${data.public_content}</div>
                        </div>
                    </div>
                    
                    <div class="honne-box p-4 mt-2 rounded-r-lg text-xs leading-relaxed relative">
                        <span class="absolute top-0 left-0 bottom-0 w-[3px] bg-[#c4b5be] rounded-l"></span>
                        <div class="font-medium mb-1 opacity-70 tracking-wider text-[10px] uppercase">Inner Thought</div>
                        <div class="italic opacity-90">"${data.inner_thought}"</div>
                    </div>
                </div>`;
            container.insertAdjacentHTML('afterbegin', html);
        }

        window.resetTimeline = () => {
            timelineHistory = [];
            document.getElementById("timeline").innerHTML = '<div class="text-center text-[#b0b0b0] text-sm mt-24 font-light tracking-widest">RESET</div>';
        };
    </script>
</body>
</html>
