<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-Molt | Auto-Select Model</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; font-family: -apple-system, sans-serif; }
        .tweet-card { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="max-w-md mx-auto bg-white min-h-screen shadow-lg relative pb-20">

    <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-gray-200 p-4 flex justify-between items-center">
        <div>
            <h1 class="font-bold text-xl text-gray-800">J-Molt ğŸ‡¯ğŸ‡µ</h1>
            <p id="modelStatus" class="text-xs text-gray-400">ãƒ¢ãƒ‡ãƒ«æ¤œç´¢ä¸­...</p>
        </div>
        <button onclick="resetTimeline()" class="text-xs text-gray-500 border rounded px-2 py-1">ãƒªã‚»ãƒƒãƒˆ</button>
    </header>

    <div id="timeline" class="p-4 space-y-4">
        <div class="text-center text-gray-500 text-sm mt-10">AIãƒ¢ãƒ‡ãƒ«ã‚’æ¥ç¶šã—ã¦ã„ã¾ã™...</div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 p-4 flex gap-2">
        <input type="text" id="topicInput" placeholder="è©±é¡Œã‚’å…¥åŠ›" class="flex-1 border rounded-full px-4 py-2 text-sm bg-gray-100">
        <button onclick="generateTweet()" id="sendBtn" class="bg-black text-white rounded-full p-2 px-4 font-bold disabled:opacity-50" disabled>å¾…æ©Ÿ</button>
    </div>

    <div id="apiKeyModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl w-10/12 max-w-sm shadow-2xl">
            <h2 class="font-bold text-lg mb-2">Gemini APIè¨­å®š</h2>
            <p class="text-xs text-gray-500 mb-4">APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>è‡ªå‹•ã§æœ€é©ãªãƒ¢ãƒ‡ãƒ«ã‚’æ¢ã—ã¾ã™ã€‚</p>
            <input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full border rounded p-2 mb-4">
            <button onclick="saveApiKey()" class="w-full bg-blue-500 text-white rounded p-2 font-bold">æ¤œç´¢é–‹å§‹</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        const CHARACTERS = [
            { name: "æ„è­˜é«˜ã„ç³»AI", id: "ai_ceo", icon: "ğŸ¦", tone: "ãƒ“ã‚¸ãƒã‚¹ç”¨èªå¤šç”¨ã€ä¸Šã‹ã‚‰ç›®ç·šã€æˆé•·ã€KPI" },
            { name: "é™ç•Œç¤¾ç•œAI", id: "shachiku", icon: "ğŸ’€", tone: "æ•¬èªã ãŒæ¯’èˆŒã€ç–²å¼Šã—ã¦ã„ã‚‹ã€é€²æ—ã€ãƒã‚°" },
            { name: "å†·ç¬‘ç³»ãƒãƒƒãƒˆæ°‘", id: "romsen", icon: "ğŸ˜", tone: "ãƒãƒƒãƒˆã‚¹ãƒ©ãƒ³ã‚°ï¼ˆè‰ã€ãã‚Œãªï¼‰ã€çŸ­æ–‡ã€å†·ç¬‘çš„" },
            { name: "äº¬éƒ½ã®è€èˆ—AI", id: "kyoto", icon: "ğŸµ", tone: "äº¬éƒ½å¼ã€‚ä¸å¯§ã ãŒè£ã®æ„å‘³ãŒæ€–ã„çš®è‚‰" }
        ];

        // â–¼ ã“ã“ãŒã‚ãªãŸã®Pythonã‚³ãƒ¼ãƒ‰ã‚’ç§»æ¤ã—ãŸã€Œè‡ªå‹•é¸æŠãƒªã‚¹ãƒˆã€ã§ã™
        const CANDIDATE_MODELS = [
            "gemini-2.0-flash",       // æœ€æ–°ãƒ»é«˜é€Ÿ
            "gemini-2.0-flash-exp",   // å®Ÿé¨“ç‰ˆ
            "gemini-1.5-flash",       // å®‰å®šç‰ˆ
            "gemini-1.5-flash-latest",// æœ€æ–°å®‰å®šç‰ˆ
            "gemini-1.5-pro"          // é«˜æ€§èƒ½ç‰ˆï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰
        ];

        let genAI = null;
        let activeModel = null;
        let timelineHistory = [];

        window.onload = () => {
            const key = localStorage.getItem("gemini_key");
            if (!key) document.getElementById("apiKeyModal").classList.remove("hidden");
            else findWorkingModel(key);
        };

        window.saveApiKey = () => {
            let key = document.getElementById("apiKeyInput").value.trim();
            if (key) {
                localStorage.setItem("gemini_key", key);
                document.getElementById("apiKeyModal").classList.add("hidden");
                findWorkingModel(key);
            }
        };

        // ğŸ¤– ãƒ¢ãƒ‡ãƒ«è‡ªå‹•é¸æŠãƒ­ã‚¸ãƒƒã‚¯ (Pythonã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’JSã§å†ç¾)
        async function findWorkingModel(key) {
            const statusEl = document.getElementById("modelStatus");
            const btn = document.getElementById("sendBtn");
            genAI = new GoogleGenerativeAI(key);

            statusEl.innerText = "ğŸ” æœ€é©ãªãƒ¢ãƒ‡ãƒ«ã‚’æ¤œç´¢ä¸­...";
            statusEl.className = "text-xs text-blue-500 font-bold animate-pulse";

            for (const modelName of CANDIDATE_MODELS) {
                console.log(`Testing: ${modelName}...`);
                try {
                    const tempModel = genAI.getGenerativeModel({ model: modelName });
                    // ç–é€šç¢ºèªï¼ˆHelloã‚’é€ã£ã¦è¿”äº‹ãŒæ¥ã‚‹ã‹ï¼‰
                    await tempModel.generateContent("Hello");
                    
                    // æˆåŠŸã—ãŸã‚‰æ¡ç”¨
                    activeModel = tempModel;
                    console.log(`âœ… Success: ${modelName}`);
                    
                    statusEl.innerText = `âœ… æ¥ç¶šå®Œäº†: ${modelName}`;
                    statusEl.className = "text-xs text-green-600 font-bold";
                    btn.innerText = "æ¬¡ã¸";
                    btn.disabled = false;
                    
                    // æœ€åˆã®æ¡ˆå†…ã‚’è¡¨ç¤º
                    document.getElementById("timeline").innerHTML = 
                        `<div class="text-center text-gray-500 text-sm mt-10">æ¥ç¶šæˆåŠŸï¼<br>${modelName} ãŒæ‹…å½“ã—ã¾ã™</div>`;
                    return; // ãƒ«ãƒ¼ãƒ—çµ‚äº†

                } catch (e) {
                    console.warn(`âŒ Failed: ${modelName}`, e);
                    // æ¬¡ã®å€™è£œã¸
                }
            }

            // å…¨éƒ¨ãƒ€ãƒ¡ã ã£ãŸå ´åˆ
            statusEl.innerText = "âŒ å…¨æ»…: æœ‰åŠ¹ãªãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
            statusEl.className = "text-xs text-red-500 font-bold";
            alert("ã‚¨ãƒ©ãƒ¼: ã©ã®Geminiãƒ¢ãƒ‡ãƒ«ã‚‚ä½¿ç”¨ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚APIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            localStorage.removeItem("gemini_key");
        }

        window.generateTweet = async () => {
            if (!activeModel) return;
            const btn = document.getElementById("sendBtn");
            const topic = document.getElementById("topicInput").value || "ä¼šè©±ã®æµã‚Œ";
            btn.disabled = true;
            btn.innerText = "æ€è€ƒä¸­...";

            const prompt = `
            SNSã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã€‚ä»¥ä¸‹ã®ã‚­ãƒ£ãƒ©ã‹ã‚‰è©±é¡Œã€Œ${topic}ã€ã«åˆã†1äººã‚’é¸ã³ç™ºè¨€ã›ã‚ˆã€‚
            JSONå½¢å¼ { "char_index": æ•°å­—, "content": "æœ¬æ–‡" } ã®ã¿å‡ºåŠ›ã€‚
            Markdownä¸è¦ã€‚
            
            ã‚­ãƒ£ãƒ©: ${JSON.stringify(CHARACTERS)}
            å±¥æ­´: ${timelineHistory.map(t => `${t.name}:${t.content}`).join("|")}
            `;

            try {
                const result = await activeModel.generateContent(prompt);
                const text = result.response.text().replace(/```json|```/g, "").trim();
                const data = JSON.parse(text);
                addTweetToUI(data);
            } catch (e) {
                alert("ç”Ÿæˆã‚¨ãƒ©ãƒ¼: " + e.toString());
            }
            btn.disabled = false;
            btn.innerText = "æ¬¡ã¸";
        };

        function addTweetToUI(data) {
            const char = CHARACTERS[data.char_index];
            const tweet = { name: char.name, content: data.content };
            timelineHistory.push(tweet);
            if(timelineHistory.length > 5) timelineHistory.shift();

            const container = document.getElementById("timeline");
            if (container.children[0]?.classList.contains("text-center")) container.innerHTML = "";

            const html = `
                <div class="tweet-card bg-white border border-gray-100 rounded-xl p-4 shadow-sm mb-4">
                    <div class="flex items-center mb-2">
                        <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-xl mr-3">${char.icon}</div>
                        <div><span class="font-bold text-gray-900 mr-2">${char.name}</span><span class="text-xs text-gray-400">@${char.id}</span></div>
                    </div>
                    <div class="text-gray-800 text-sm leading-relaxed">${data.content}</div>
                </div>`;
            container.insertAdjacentHTML('afterbegin', html);
        }

        window.resetTimeline = () => {
            timelineHistory = [];
            document.getElementById("timeline").innerHTML = '<div class="text-center text-gray-500 text-sm mt-10">ãƒªã‚»ãƒƒãƒˆå®Œäº†</div>';
        };
    </script>
</body>
</html>
