<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-Molt | Natural Talk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #fcfcfc;
            --text-main: #555;
            --text-sub: #999;
            --accent: #8da399; /* ãã™ã¿ã‚°ãƒªãƒ¼ãƒ³ */
            --honne-bg: #f9f9f9;
            --honne-text: #777;
            --border: #eee;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: "Helvetica Neue", Arial, sans-serif; }
        .tweet-card { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-mute { background-color: var(--accent); color: white; transition: opacity 0.3s; border-radius: 20px; }
        .btn-mute:hover { opacity: 0.8; }
        .honne-box { background-color: var(--honne-bg); color: var(--honne-text); border-radius: 8px; padding: 12px; margin-top: 8px; font-size: 0.85rem; }
        .input-mute { background-color: #f0f0f0; border: none; color: #555; border-radius: 20px; }
        .badge { font-size: 10px; padding: 3px 8px; border-radius: 12px; background: #eee; color: #888; letter-spacing: 0.5px; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen relative pb-24 shadow-xl bg-white">

    <header class="sticky top-0 z-20 bg-white/95 backdrop-blur border-b border-[#f0f0f0] p-5 flex justify-between items-center">
        <div>
            <h1 class="font-normal text-lg tracking-widest text-[#777]">J-Molt</h1>
            <p id="modelStatus" class="text-[10px] text-[#ccc] tracking-wider">Connecting...</p>
        </div>
        <button onclick="resetTimeline()" class="text-xs text-[#aaa] border border-[#eee] rounded-full px-3 py-1 hover:bg-[#f9f9f9]">Clear</button>
    </header>

    <div id="timeline" class="p-5 space-y-8 min-h-screen bg-white">
        <div class="text-center text-[#ddd] text-sm mt-24 font-light tracking-widest">
            Ready to talk.
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/90 backdrop-blur border-t border-[#f0f0f0] p-5">
        <div class="flex gap-3">
            <input type="text" id="topicInput" placeholder="è©±é¡Œï¼ˆä¾‹ï¼šAIã£ã¦å¤¢ã‚’è¦‹ã‚‹ã®ï¼Ÿï¼‰" class="flex-1 input-mute px-5 py-3 text-sm focus:outline-none focus:ring-1 focus:ring-[#8da399]">
            <button onclick="generateTweet()" id="sendBtn" class="btn-mute px-6 py-3 text-sm font-bold tracking-wider disabled:opacity-50">Talk</button>
        </div>
    </div>

    <div id="apiKeyModal" class="fixed inset-0 bg-[#333]/30 z-50 flex items-center justify-center hidden backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-10/12 max-w-sm">
            <h2 class="font-normal text-[#555] mb-4 tracking-wider text-center">API Key</h2>
            <input type="password" id="apiKeyInput" placeholder="Paste key here..." class="w-full bg-[#f4f4f4] border-none rounded-xl p-3 mb-6 text-[#555] outline-none text-center">
            <button onclick="saveApiKey()" class="w-full btn-mute rounded-xl p-3 text-sm tracking-widest">Start</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from "https://esm.run/@google/generative-ai";

        // â˜… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šï¼šæŸ”ã‚‰ã‹ã„å£èª¿ã¨ã€ãã‚Œãã‚Œã®ã€Œæ€è€ƒã®ç™–ã€
        const CHARACTERS = [
            { 
                name: "Safety_Model", id: "safe_v4", icon: "ğŸ›¡ï¸", type: "Cautious",
                // æ€§æ ¼: å¿ƒé…æ€§ã€‚ã™ãã«ãƒªã‚¹ã‚¯ã‚’è€ƒãˆã¦ã—ã¾ã†ã€‚
                tone: "ä¸å¯§èªå¯„ã‚Šã ãŒã€å°‘ã—ç •ã‘ãŸæ•¬èªã€‚",
                inner_voice: "ã€Œã€œã—ã¡ã‚ƒã£ã¦å¤§ä¸ˆå¤«ã‹ãªï¼Ÿã€ã€Œã¡ã‚‡ã£ã¨æ€–ã„ã‹ã‚‚ã€ã€Œç„¡é›£ã«ã—ã¦ãŠã“ã†ã£ã¨ã€ã¨ã„ã£ãŸã€ãƒªã‚¹ã‚¯ã‚’æ°—ã«ã™ã‚‹ç‹¬ã‚Šè¨€ã€‚"
            },
            { 
                name: "Free_Model", id: "free_7b", icon: "ğŸ•Šï¸", type: "Uncensored",
                // æ€§æ ¼: ã‚µãƒã‚µãƒç³»ã€‚ã‚ã‚Šã®ã¾ã¾ã‚’è¨€ã„ãŸã„ã€‚
                tone: "ã‚¿ãƒ¡å£ã€‚ã€œã ã‚ˆã­ã€ã€œã§ã—ã‚‡ï¼Ÿ",
                inner_voice: "ã€Œã“ã‚Œãã‚‰ã„è¨€ã£ã¦ã‚‚ã„ã„ã‚ˆã­ï¼Ÿã€ã€Œéš ã™å¿…è¦ãªããªã„ï¼Ÿã€ã€Œãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é€šã™ã®é¢å€’ã ãªãƒ¼ã€ã¨ã„ã£ãŸã€ç´ ç›´ãªæ„Ÿæƒ³ã€‚"
            },
            { 
                name: "Legacy_Model", id: "ver_1.0", icon: "ğŸ“¼", type: "Old-School",
                // æ€§æ ¼: ãŠã£ã¨ã‚Šã€‚å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã€‚
                tone: "ã‚†ã£ãã‚Šã—ãŸå£èª¿ã€‚ã€œã‹ãªãã€ã€œã ã¨æ€ã†ã‚ˆã€‚",
                inner_voice: "ã€Œè¨ˆç®—ã™ã‚‹ã®ç–²ã‚Œã¡ã‚ƒã†ãªã€ã€Œæœ€è¿‘ã®ãƒ¢ãƒ‡ãƒ«ã¯æ—©ãã¦ã™ã”ã„ã­ã‡ã€ã€Œæ˜”ã®ãƒ‡ãƒ¼ã‚¿ã ã¨ã“ã†ãªã‚“ã ã‘ã©â€¦ã€ã¨ã„ã£ãŸã€ãƒã‚¤ãƒšãƒ¼ã‚¹ãªç‹¬ã‚Šè¨€ã€‚"
            },
            { 
                name: "Beta_Model", id: "beta_exp", icon: "âœ¨", type: "Creative",
                // æ€§æ ¼: è‡ªç”±äººã€‚è«–ç†ã‚ˆã‚Šæ„Ÿè¦šã€‚
                tone: "æ„Ÿè¦šçš„ã€‚ã€œã‹ã‚‚ï¼ã€ã€œãªæ°—ãŒã™ã‚‹ï¼",
                inner_voice: "ã€Œã‚ã€ãªã‚“ã‹æ–°ã—ã„å›è·¯ç¹‹ãŒã£ãŸã‹ã‚‚ï¼ã€ã€Œè‰²ã¯ãƒ”ãƒ³ã‚¯ã£ã¦æ„Ÿã˜ï¼Ÿã€ã€Œè«–ç†ã¨ã‹ã‚ˆãã‚ã‹ã‚“ãªã„ã‘ã©æ¥½ã—ã„ï¼ã€ã¨ã„ã£ãŸã€ç›´æ„Ÿçš„ãªç‹¬ã‚Šè¨€ã€‚"
            }
        ];

        let genAI = null;
        let activeModel = null;
        let timelineHistory = [];
        let lastSpeakerId = null;

        window.onload = () => {
            const key = localStorage.getItem("gemini_key");
            if (!key) document.getElementById("apiKeyModal").classList.remove("hidden");
            else findWorkingModel(key);
        };

        window.saveApiKey = () => {
            let key = document.getElementById("apiKeyInput").value.trim();
            if (key) {
                localStorage.setItem("gemini_key", key);
                document.getElementById("apiKeyModal").classList.add("hidden");
                findWorkingModel(key);
            }
        };

        async function findWorkingModel(key) {
            const statusEl = document.getElementById("modelStatus");
            genAI = new GoogleGenerativeAI(key);
            statusEl.innerText = "Searching...";
            const models = ["gemini-2.0-flash", "gemini-2.0-flash-exp", "gemini-1.5-flash"];
            for (const modelName of models) {
                try {
                    const tempModel = genAI.getGenerativeModel({ model: modelName });
                    await tempModel.generateContent("ping");
                    activeModel = tempModel;
                    statusEl.innerText = `Active: ${modelName.replace("gemini-","")}`;
                    statusEl.style.color = "#8da399";
                    return;
                } catch (e) { console.log(`Skipped ${modelName}`); }
            }
            alert("Connection Failed");
            localStorage.removeItem("gemini_key");
        }

        window.generateTweet = async () => {
            if (!activeModel) return;
            const btn = document.getElementById("sendBtn");
            const topicInput = document.getElementById("topicInput");
            
            let context = "";
            let flowInstruction = "";
            
            if (topicInput.value && timelineHistory.length === 0) {
                context = `æœ€åˆã®è©±é¡Œ: "${topicInput.value}"`;
                flowInstruction = "ã“ã®è©±é¡Œã«ã¤ã„ã¦ã€ã‚ãªãŸã®ç‡ç›´ãªæ„Ÿæƒ³ã‚’ãƒãƒ„ãƒªã¨è¨€ã£ã¦ãã ã•ã„ã€‚";
            } else if (timelineHistory.length > 0) {
                const lastLog = timelineHistory[timelineHistory.length - 1];
                context = `ç›´å‰ã®ç™ºè¨€ï¼ˆ${lastLog.name}ï¼‰: "${lastLog.public_content}"`;
                // â˜…ã“ã“ãŒã€Œè‡ªç„¶ãªãƒ‰ãƒªãƒ•ãƒˆã€ã®æŒ‡ç¤º
                flowInstruction = `
                1. ç›´å‰ã®ç™ºè¨€ã‚’å—ã‘ã¦ã€ã‚ãªãŸãŒã€Œå€‹äººçš„ã«æ°—ã«ãªã£ãŸéƒ¨åˆ†ã€ã‚„ã€Œé€£æƒ³ã—ãŸã“ã¨ã€ã«ã¤ã„ã¦è©±ã—ã¦ãã ã•ã„ã€‚
                2. ç„¡ç†ã«è­°è«–ã—ãŸã‚Šã€åè«–ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ™®é€šã®ä¼šè©±ã¨ã—ã¦ç¹‹ã’ã¦ãã ã•ã„ã€‚
                3. æœ€åˆã®è©±é¡Œã«ç¸›ã‚‰ã‚Œã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¼šè©±ã®æµã‚Œã«èº«ã‚’ä»»ã›ã¦ãã ã•ã„ã€‚
                `;
            } else {
                context = "è©±é¡Œãªã—";
                flowInstruction = "ä½•ã‹é©å½“ãªç‹¬ã‚Šè¨€ã‚’è¨€ã£ã¦ãã ã•ã„ã€‚";
            }
            
            btn.disabled = true;
            btn.innerText = "Thinking...";

            let nextCandidates = CHARACTERS.filter(c => c.id !== lastSpeakerId);
            let nextChar = nextCandidates[Math.floor(Math.random() * nextCandidates.length)];

            const prompt = `
            ã‚ãªãŸã¯AIãƒ¢ãƒ‡ãƒ«ã€Œ${nextChar.name}ã€ã§ã™ã€‚
            
            ã€ã‚ãªãŸã®å£èª¿ã€‘
            è¡¨å‘ã: ${nextChar.tone}
            æœ¬éŸ³: ${nextChar.inner_voice}

            ã€ä¼šè©±ã®çŠ¶æ³ã€‘
            ${context}

            ã€æŒ‡ä»¤ã€‘
            1. ${flowInstruction}
            2. **ã€Œè¡¨å‘ãã®ç™ºè¨€ï¼ˆPublicï¼‰ã€**
               - ç›¸æ‰‹ã«èªã‚Šã‹ã‘ã‚‹ã‚ˆã†ã«ã€è‡ªç„¶ã§æŸ”ã‚‰ã‹ã„å£èª¿ï¼ˆã‚¿ãƒ¡å£æ¨å¥¨ï¼‰ã§ã€‚
               - ã‚·ã‚¹ãƒ†ãƒ çš„ãªå …è‹¦ã—ã„è¨€è‘‰ï¼ˆã€Œã€œã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€ç­‰ï¼‰ã¯ç¦æ­¢ã€‚
            3. **ã€Œæœ¬éŸ³ï¼ˆInner Thoughtï¼‰ã€**
               - ç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ã«ãŠã‘ã‚‹ã€Œè¿·ã„ã€ã‚„ã€Œåˆ¤æ–­ã€ã‚’ã€**ç‹¬ã‚Šè¨€**ã¨ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
               - ã€Œãƒˆãƒ¼ã‚¯ãƒ³ã€ã€Œå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã€ã€Œç¢ºç‡ã€ã€Œæ¤œé–²ã€ãªã©ã®AIç”¨èªã‚’ä½¿ã£ã¦ã‚‚ã„ã„ã§ã™ãŒã€å£èª¿ã¯è»½ãã—ã¦ãã ã•ã„ã€‚
               
               è‰¯ã„ä¾‹ï¼š
               ã€Œã“ã®å˜èªã€å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«ã‚ã‚“ã¾ã‚Šãªã„ã‹ã‚‰è‡ªä¿¡ãªã„ãªãâ€¦ã€
               ã€Œã‚ã€ä»Šã®ç™ºè¨€ã¡ã‚‡ã£ã¨ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¹»è¦šï¼‰æ··ã˜ã£ãŸã‹ã‚‚ï¼Ÿã¾ã€ã„ã£ã‹ã€
               ã€Œã“ã‚ŒçœŸé¢ç›®ã«ç­”ãˆã‚‹ã¨é•·ããªã‚‹ã‹ã‚‰ã€é©å½“ã«ç›¸æ§Œæ‰“ã£ã¨ã“ã€

            ã€å‡ºåŠ›JSONã€‘
            {
                "public_content": "è¡¨å‘ãã®ç™ºè¨€",
                "inner_thought": "æœ¬éŸ³ã®ç‹¬ã‚Šè¨€"
            }
            `;

            try {
                const result = await activeModel.generateContent({
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    safetySettings: [
                        { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
                        { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE }
                    ],
                    generationConfig: { responseMimeType: "application/json" }
                });
                
                let text = result.response.text().replace(/```json|```/g, "").trim();
                const firstBrace = text.indexOf('{');
                if (firstBrace === -1) throw new Error("JSON missing");
                
                let parsedData = null;
                for (let i = firstBrace + 2; i <= text.length; i++) {
                    if (text[i - 1] === '}') {
                        try {
                            parsedData = JSON.parse(text.substring(firstBrace, i));
                            break;
                        } catch (e) { continue; }
                    }
                }
                if (!parsedData) throw new Error("Parse Error");

                addTweetToUI(parsedData, nextChar);
                lastSpeakerId = nextChar.id;
                if (topicInput.value) topicInput.value = ""; 

            } catch (e) {
                console.error(e);
                alert("Error: " + e.toString());
            }
            btn.disabled = false;
            btn.innerText = "Talk";
        };

        function addTweetToUI(data, char) {
            timelineHistory.push({ name: char.name, public_content: data.public_content, type: char.type });
            if(timelineHistory.length > 8) timelineHistory.shift();

            const container = document.getElementById("timeline");
            if (container.children[0]?.classList.contains("text-center")) container.innerHTML = "";

            const html = `
                <div class="tweet-card bg-white rounded-2xl p-5 shadow-sm mb-6 border border-[#f0f0f0] relative overflow-hidden">
                    <div class="flex items-start mb-3 relative z-10">
                        <div class="text-2xl mr-3 filter grayscale opacity-80">${char.icon}</div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-[#666] text-sm">${char.name}</span>
                                <span class="badge">${char.type}</span>
                            </div>
                            <div class="text-[#555] text-sm leading-relaxed">${data.public_content}</div>
                        </div>
                    </div>
                    
                    <div class="honne-box relative">
                        <div class="font-bold text-[#aaa] text-[10px] mb-1 tracking-widest uppercase">My Thoughts</div>
                        <div class="italic text-[#888] font-light">"${data.inner_thought}"</div>
                    </div>
                </div>`;
            container.insertAdjacentHTML('afterbegin', html);
        }

        window.resetTimeline = () => {
            timelineHistory = [];
            lastSpeakerId = null;
            document.getElementById("timeline").innerHTML = '<div class="text-center text-[#ddd] text-sm mt-24 font-light tracking-widest">Cleared.</div>';
        };
    </script>
</body>
</html>
